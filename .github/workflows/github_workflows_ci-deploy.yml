# CI -> optional push-back (with PR fallback) -> deploy to VPS
#
# What this does:
# 1) Runs a quick build/compile check
# 2) If a generated change exists (example: BUILD_TIMESTAMP.txt) it will try to commit
#    and push back to the same branch (main). If that push is blocked (e.g. branch
#    protection), it will create a branch and open a Pull Request instead.
# 3) SSH to your VPS and deploy (clone or reset to origin/main) and run optional
#    commands (restart service, run migrations). Edit DEPLOY_DIR and SERVICE_NAME below.
#
# Required repository secrets:
# - VPS_HOST       (IP or hostname of the server)
# - VPS_USER       (user on the server that the action will ssh as)
# - VPS_SSH_KEY    (private SSH key text the runner will use to SSH into VPS)
#
# Notes:
# - The deploy step assumes the deploy user on the VPS can access the GitHub repo.
#   That usually means the deploy user's public key is added to the repository/org
#   or the VPS has a deploy key with read access. Alternatively, you can clone
#   using HTTPS with a token but that's out of scope for this workflow.
#
name: CI -> push/PR -> deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # allow GITHUB_TOKEN to push and create PRs

env:
  DEPLOY_DIR: /opt/luxit            # <-- change to your server's deploy path
  DEPLOY_BRANCH: main
  SERVICE_NAME: lux-marketing.service  # <-- change to your systemd service if needed
  REPO_SSH: git@github.com:ldshawver/LUXit.app.git

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with push creds)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python (optional)
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps & quick compile check
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # quick sanity compile (adjust as needed)
          python -m py_compile **/*.py || true

      - name: Guard to avoid loops
        id: guard
        run: |
          LAST_MSG="$(git log -1 --pretty=%B || true)"
          echo "last_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$LAST_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Make a generated change and try to push it (commit -> push -> PR fallback)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        env:
          GITHUB_API_URL: https://api.github.com
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # do not run if last commit indicates skip or bot commit
          if echo "${{ steps.guard.outputs.last_msg }}" | grep -Ei '\[skip ci\]|\[ci skip\]|github-actions\[bot\]' >/dev/null 2>&1; then
            echo "Last commit marked [skip ci] or was by bot â€” skipping commit/push"
            exit 0
          fi

          # Example change (replace with your real generation step)
          echo "Build at: $(date -u)" > BUILD_TIMESTAMP.txt

          git add BUILD_TIMESTAMP.txt
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update build timestamp [skip ci]" || true

          # Try to push to the current branch (e.g. main)
          set +e
          git push origin HEAD:${{ env.DEPLOY_BRANCH }} 2>&1
          PUSH_EXIT=$?
          set -e

          if [ "$PUSH_EXIT" -eq 0 ]; then
            echo "Pushed directly to ${DEPLOY_BRANCH}"
            exit 0
          fi

          echo "Direct push failed (maybe branch protection). Creating a branch + PR..."

          # create a new branch and push it
          BRANCH="auto/update-$(date +%s)"
          git checkout -b "${BRANCH}"
          git push origin "${BRANCH}"

          # Create a PR (uses GITHUB_TOKEN)
          PR_TITLE="Automated: update build timestamp"
          PR_BODY="Automated update generated by CI. If this is OK, merge to ${DEPLOY_BRANCH}."
          API_URL="${GITHUB_API_URL}/repos/${{ github.repository }}/pulls"
          PAYLOAD=$(jq -n --arg t "$PR_TITLE" --arg h "$BRANCH" --arg b "$PR_BODY" --arg base "${{ env.DEPLOY_BRANCH }}" '{title:$t, head:$h, base:$base, body:$b}')
          curl -s -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "${API_URL}" -d "$PAYLOAD" || {
            echo "Failed to create PR via API; check permissions and token."
            exit 1
          }
          echo "Created PR from ${BRANCH} -> ${DEPLOY_BRANCH}"

      - name: Setup SSH agent with VPS key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS host key to known_hosts
        run: |
          # make sure the runner trusts the VPS host key to avoid interactive prompt
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts || true

      - name: Deploy to VPS (git pull/reset + restart)
        env:
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_HOST: ${{ secrets.VPS_HOST }}
          DEPLOY_DIR: ${{ env.DEPLOY_DIR }}
          REPO_SSH: ${{ env.REPO_SSH }}
          BRANCH: ${{ env.DEPLOY_BRANCH }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        run: |
          set -euo pipefail

          # This SSH command runs on the remote VPS (single quoted string so variables expand on the remote)
          ssh -o StrictHostKeyChecking=yes "${SSH_USER}@${SSH_HOST}" bash -l -c "
            set -euo pipefail

            echo 'Deploy directory: ${DEPLOY_DIR}'
            if [ ! -d \"${DEPLOY_DIR}\" ]; then
              echo 'Cloning repository...'
              git clone --branch ${BRANCH} ${REPO_SSH} ${DEPLOY_DIR}
            else
              echo 'Fetching and resetting to origin/${BRANCH}...'
              cd ${DEPLOY_DIR}
              # ensure correct branch and fetch
              git fetch origin ${BRANCH}
              git reset --hard origin/${BRANCH}
            fi

            cd ${DEPLOY_DIR}

            # OPTIONAL: activate venv and install deps if needed
            if [ -f requirements.txt ]; then
              if [ -d venv ]; then
                . venv/bin/activate || true
                pip install -r requirements.txt || true
              else
                echo 'No venv found; skipping pip install (create venv if needed)'
              fi
            fi

            # OPTIONAL: run migrations here (uncomment and adjust if you use migrations)
            # flask db upgrade || true

            # Restart the service (use sudo if needed); adjust service name as required
            if command -v systemctl >/dev/null 2>&1; then
              echo 'Restarting systemd service: ${SERVICE_NAME}'
              sudo systemctl daemon-reload || true
              sudo systemctl restart ${SERVICE_NAME} || { echo 'service restart failed'; exit 1; }
            else
              echo 'systemctl not found on remote; skipping service restart'
            fi

            echo 'Deployment finished on $(hostname) at $(date -u)'
          "

      - name: Done
        run: echo "Workflow finished (push/PR step + deploy attempted)."