- name: Deploy to VPS
  env:
    SSH_USER: ${{ secrets.VPS_USER }}
    SSH_HOST: ${{ secrets.VPS_HOST }}
    DEPLOY_DIR: /opt/luxit
    REPO_SSH: git@github.com:ldshawver/LUXit.app.git
    BRANCH: main
    SERVICE_NAME: lux-marketing.service
  run: |
    set -euo pipefail

    ssh -o StrictHostKeyChecking=yes -i ~/.ssh/id_ed25519_vps_actions "${SSH_USER}@${SSH_HOST}" bash -l <<'REMOTE'
      set -euo pipefail

      DEPLOY_DIR=/opt/luxit
      BRANCH=main
      REPO_SSH=git@github.com:ldshawver/LUXit.app.git
      SERVICE_NAME=lux-marketing.service

      # Avoid 'dubious ownership' safety block for this directory (idempotent)
      git config --global --add safe.directory "${DEPLOY_DIR}" || true

      if [ ! -d "${DEPLOY_DIR}" ]; then
        echo "== remote: cloning repository..."
        git clone --branch "${BRANCH}" "${REPO_SSH}" "${DEPLOY_DIR}"
      else
        echo "== remote: fetching..."
        cd "${DEPLOY_DIR}" || exit 1
        git fetch origin "${BRANCH}" --quiet || true

        # prefer resetting to remote tracking branch if it exists, otherwise use FETCH_HEAD
        if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
          git reset --hard "origin/${BRANCH}"
        else
          HASH=$(git rev-parse --verify FETCH_HEAD 2>/dev/null || true)
          if [ -n "${HASH}" ]; then
            git checkout -B "${BRANCH}" "${HASH}"
            git reset --hard "${HASH}"
          else
            # fallback attempt
            git fetch origin "${BRANCH}" --quiet
            git checkout -B "${BRANCH}" "origin/${BRANCH}"
            git reset --hard "origin/${BRANCH}"
          fi
        fi
      fi

      # Ensure future pulls use SSH (so actions can pull via the key if needed)
      git remote set-url origin "${REPO_SSH}" || true

      # Optional: activate virtualenv and install deps (if present)
      if [ -f requirements.txt ] && [ -d venv ]; then
        . venv/bin/activate || true
        pip install -r requirements.txt || true
      fi

      # Restart service and print logs
      sudo systemctl daemon-reload || true
      sudo systemctl restart "${SERVICE_NAME}" || true
      sudo systemctl status "${SERVICE_NAME}" --no-pager -l
      sudo journalctl -u "${SERVICE_NAME}" -n 200 --no-pager

      echo "== remote: done"
REMOTE
