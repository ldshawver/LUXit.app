name: Deploy + Smoke Test (LUXit VPS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy + Smoke Test over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -euxo pipefail

            echo "=== WHOAMI / HOST ==="
            whoami
            hostname
            pwd || true

            echo "=== VERIFY APP DIR ==="
            test -d /opt/luxit
            cd /opt/luxit

            echo "=== GIT STATUS ==="
            git rev-parse --is-inside-work-tree || true
            git remote -v || true
            git status --porcelain || true
            git rev-parse HEAD || true

            echo "=== PYTHON COMPILE CHECK ==="
            source venv/bin/activate
            python -m py_compile app.py wsgi.py auth.py routes.py 2>/dev/null || python -m py_compile app.py

            echo "=== RESTART SERVICE ==="
            systemctl restart lux
            sleep 2
            systemctl status lux --no-pager -l

            echo "=== LOCAL HEALTH CHECKS (DIRECT GUNICORN) ==="
            curl -sS -D- http://127.0.0.1:8000/ -o /dev/null || true
            curl -sS -D- http://127.0.0.1:8000/auth/login -o /dev/null || true

            echo "=== HTTPS CHECK THROUGH NGINX ==="
            curl -k -sS -D- https://luxit.app/ -o /dev/null || true
            curl -k -sS -D- https://luxit.app/auth/login -o /dev/null || true

            echo "=== IF ANYTHING IS 500, DUMP LOGS ==="
            echo "--- last 200 gunicorn/systemd lines ---"
            journalctl -u lux -n 200 --no-pager || true
            echo "--- nginx error log tail ---"
            tail -n 200 /var/log/nginx/error.log || true
            echo "--- nginx config (relevant) ---"
            nginx -T 2>/dev/null | sed -n '1,220p' || true
