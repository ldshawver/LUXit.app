- name: Deploy to VPS
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USER }}
    key: ${{ secrets.VPS_SSH_KEY }}
    port: 22
    timeout: 30s
    command_timeout: 10m
    script: |
      set -euxo pipefail

      echo "ğŸ“¦ Connected"
      whoami
      hostname
      pwd || true

      echo "ğŸ“ Checking app directory"
      if [ ! -d "/var/www/lux-marketing" ]; then
        echo "âŒ /var/www/lux-marketing not found"
        ls -la /var/www || true
        exit 1
      fi

      cd /var/www/lux-marketing

      echo "ğŸ” Files:"
      ls -la

      echo "ğŸ Activating virtualenv"
      if [ ! -f "venv/bin/activate" ]; then
        echo "âŒ venv missing at venv/bin/activate"
        exit 1
      fi
      source venv/bin/activate

      echo "ğŸ§ª Python compile check"
      python3 -m py_compile app.py

      echo "ğŸ” Restarting systemd service"
      sudo -n systemctl restart lux-marketing || {
        echo "âŒ Restart failed"
        sudo systemctl status lux-marketing --no-pager -l || true
        sudo journalctl -u lux-marketing -n 200 --no-pager || true
        exit 1
      }

      echo "ğŸŒ¡ï¸ Health check"
      if timeout 15 curl -sSf http://127.0.0.1:5000/ >/dev/null; then
        echo "âœ… App responding locally"
      else
        echo "âŒ App not responding"
        sudo systemctl status lux-marketing --no-pager -l || true
        sudo journalctl -u lux-marketing -n 200 --no-pager || true
        exit 1
      fi

      echo "âœ… Deployment complete"
