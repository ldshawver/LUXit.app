name: Deploy LUXit.app to VPS (main only)

on:
  push:
    branches:
      - main   # ONLY main deploys

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euxo pipefail

            echo "üì¶ Connect OK - reporting remote user/host"
            whoami
            hostname
            pwd || true

            echo "üìÅ Check app directory and venv"
            if [ ! -d "/opt/lux-marketing" ]; then
              echo "‚ùå /opt/lux-marketing not found"
              ls -la /
              exit 1
            fi
            cd /opt/lux-marketing

            echo "üîé Show files"
            ls -la

            echo "üêç Check virtualenv"
            if [ ! -f "venv/bin/activate" ]; then
              echo "‚ùå venv not found at venv/bin/activate"
              exit 1
            fi
            source venv/bin/activate

            echo "üß™ Python compile check"
            python3 -m py_compile app.py

            echo "üîÅ Restarting service (no passwordless sudo will fail here)"
            # Prefer running as root user or ensure VPS_USER has passwordless sudo for systemctl
            sudo -n systemctl restart lux.service || {
              echo "‚ùå systemctl restart failed - showing journal and service status"
              sudo systemctl status lux --no-pager -l || true
              sudo journalctl -u lux -n 200 --no-pager || true
              exit 1
            }

            echo "‚úÖ Deployment complete - quick health check"
            if timeout 15 curl -sSf http://127.0.0.1:5000/ >/dev/null 2>&1; then
              echo "‚úÖ Backend responding locally"
            else
              echo "‚ùå Backend not responding locally - dumping service status + journal"
              sudo systemctl status lux --no-pager -l || true
              sudo journalctl -u lux -n 200 --no-pager || true
              exit 1
            fi
