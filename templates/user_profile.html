{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i data-feather="user"></i> User Profile</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Account Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Full Name:</strong></td>
                        <td>{{ user.full_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>First Name:</strong></td>
                        <td>{{ user.first_name or 'Not provided' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Last Name:</strong></td>
                        <td>{{ user.last_name or 'Not provided' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Username:</strong></td>
                        <td>{{ user.username }}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>{{ user.email }}</td>
                    </tr>
                    <tr>
                        <td><strong>Phone:</strong></td>
                        <td>{{ user.phone or 'Not provided' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Segment:</strong></td>
                        <td>
                            <span class="badge" style="background: {% if user.segment == 'admin' %}#e4055c{% elif user.segment == 'moderator' %}#0044ff{% else %}#00ffb4{% endif %}; color: white;">{{ user.segment.upper() }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Role:</strong></td>
                        <td>
                            {% if user.is_admin_user %}
                                <span class="badge bg-danger">Administrator</span>
                            {% else %}
                                <span class="badge bg-secondary">User</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if user.tags %}
                    <tr>
                        <td><strong>Tags:</strong></td>
                        <td>
                            {% for tag in user.tags.split(',') %}
                                <span class="badge bg-info">{{ tag.strip() }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>Member Since:</strong></td>
                        <td>{{ user.created_at.strftime('%B %d, %Y') }}</td>
                    </tr>
                </table>
                
                <div class="d-grid gap-2 d-md-block">
                    <a href="{{ url_for('main.edit_user_profile') }}" class="btn btn-primary">
                        <i data-feather="edit"></i> Edit Profile
                    </a>
                    <a href="{{ url_for('user.change_password') }}" class="btn btn-outline-secondary">
                        <i data-feather="key"></i> Change Password
                    </a>
                    {% if user.is_admin %}
                    <a href="{{ url_for('user.manage_users') }}" class="btn btn-outline-secondary">
                        <i data-feather="users"></i> Manage Users
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('main.contacts') }}" class="list-group-item list-group-item-action">
                        <i data-feather="users"></i> View Contacts
                    </a>
                    <a href="{{ url_for('main.campaigns') }}" class="list-group-item list-group-item-action">
                        <i data-feather="mail"></i> View Campaigns
                    </a>
                    <a href="{{ url_for('main.templates') }}" class="list-group-item list-group-item-action">
                        <i data-feather="file-text"></i> Email Templates
                    </a>
                    <a href="{{ url_for('main.analytics') }}" class="list-group-item list-group-item-action">
                        <i data-feather="bar-chart-2"></i> Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #000000 0%, #1a001a 100%); border: 2px solid #bc00ed;">
            <div class="card-header" style="background: #bc00ed; color: white;">
                <h5 class="card-title mb-0"><i data-feather="briefcase"></i> My Companies</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Your Role</th>
                                <th>Default</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in all_companies %}
                            <tr>
                                <td>
                                    <strong style="color: #00ffb4;">{{ comp.name }}</strong>
                                    {% if comp.industry %}<br><small style="color: #888;">{{ comp.industry }}</small>{% endif %}
                                </td>
                                <td>
                                    {% set role = company_roles.get(comp.id, 'viewer') %}
                                    <span class="badge" style="background: {% if role == 'owner' %}#e4055c{% elif role == 'admin' %}#bc00ed{% elif role == 'editor' %}#0044ff{% else %}#444{% endif %}; color: white;">
                                        {{ role|upper if role else 'VIEWER' }}
                                    </span>
                                </td>
                                <td>
                                    {% if user.default_company_id == comp.id %}
                                    <span class="badge bg-success"><i data-feather="check"></i> Default</span>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" onclick="setDefaultCompany({{ comp.id }})">Set Default</button>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('main.company_settings', company_id=comp.id) }}" class="btn btn-sm" style="background: #bc00ed; color: white;">
                                        <i data-feather="settings"></i> Settings
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center" style="color: #888;">No companies available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function setDefaultCompany(companyId) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    try {
        const response = await fetch('/api/user/set-default-company', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ company_id: companyId })
        });
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error setting default company: ' + data.error);
        }
    } catch (e) {
        alert('Error setting default company');
    }
}
</script>
{% endblock %}
